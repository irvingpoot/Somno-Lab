---
import BackButton from '../components/BackButton.astro';
import Layout from '../layouts/Layout.astro';
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

// 2. LÓGICA DEL SERVIDOR
if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const action = data.get("action");
    
    // Datos del formulario
    const evento = {
        titulo: data.get("titulo"),
        categoria: data.get("categoria"),
        fecha: data.get("fecha"),
        hora: data.get("hora"),
        lugar: data.get("lugar"),
        precio: data.get("precio"),
        img: data.get("img"),
        descripcion: data.get("descripcion"),
        destacado: data.get("destacado") === 'on'
    };

    if (action === "create") {
        await supabase.from('eventos').insert([evento]);
    } 
    else if (action === "update") {
        const id = data.get("id");
        await supabase.from('eventos').update(evento).eq('id', id);
    } 
    else if (action === "delete") {
        const id = data.get("id");
        await supabase.from('eventos').delete().eq('id', id);
    }
}

// 3. OBTENER LISTA
const { data: eventos, error } = await supabase
    .from('eventos')
    .select('*')
    .order('fecha', { ascending: false });

if (error) console.error("Error cargando eventos:", error);
---

<Layout title="Gestión de Eventos | SomnoLab" showFooter={false}>

    <div class="absolute top-8 left-5 xs:p-5 animate-fade-in-down" style="animation-delay: 0.1s;">
        <BackButton href="/dashboard" label="Volver al dashboard" />
    </div>
    
    <div class="bg-slate-50 min-h-screen py-12">
        <div class="max-w-[95%] mx-auto px-4">
            
            <div class="flex flex-col items-center justify-center mb-8">
                <h1 class="font-black tracking-tighter mt-15 lg:mt-0 text-5xl md:text-6xl mb-6">
                    <span class="bg-clip-text text-transparent bg-linear-to-r from-somno-light via-somno to-somno-dark pr-4">
                        Gestión de Eventos
                    </span>
                </h1>
                <p class="text-slate-500">Agrega, edita o elimina eventos.</p>
                <a href="/eventos" target="_blank" class="text-somno font-bold pt-2 hover:underline">
                    Ver página pública <i class="fas fa-external-link-alt ml-1"></i>
                </a>
            </div>

            <div class="grid lg:grid-cols-12 gap-8 items-start">
                
                <div class="lg:col-span-4 lg:sticky lg:top-8">
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
                        <h2 id="form-title" class="text-xl font-bold text-somno mb-6 border-b pb-2">
                            Nuevo Evento
                        </h2>

                        <form method="POST" class="space-y-4" id="event-form">
                            <input type="hidden" name="id" id="event-id">
                            <input type="hidden" name="action" id="form-action" value="create">

                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Título</label>
                                <input required type="text" name="titulo" id="titulo" class="w-full p-3 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-somno outline-none text-sm">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                                    <input required type="date" name="fecha" id="fecha" class="w-full p-3 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-somno outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hora</label>
                                    <input required type="text" name="hora" id="hora" placeholder="Ej: 19:00 hrs" class="w-full p-3 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-somno outline-none text-sm">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categoría</label>
                                    <select name="categoria" id="categoria" class="w-full p-3 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-somno outline-none text-sm">
                                        <option>Salud Integral</option>
                                        <option>Taller Técnico</option>
                                        <option>Conferencia</option>
                                        <option>Bienestar</option>
                                        <option>Otro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Precio</label>
                                    <input type="text" name="precio" id="precio" placeholder="Ej: Gratuito" class="w-full p-3 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-somno outline-none text-sm">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lugar</label>
                                <input type="text" name="lugar" id="lugar" placeholder="Ej: Zoom / Auditorio" class="w-full p-3 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-somno outline-none text-sm">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">URL Imagen</label>
                                <input required type="url" name="img" id="img" placeholder="https://..." class="w-full p-3 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-somno outline-none text-sm">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Descripción</label>
                                <textarea name="descripcion" id="descripcion" rows="4" class="w-full p-3 bg-slate-50 border rounded-lg focus:ring-2 focus:ring-somno outline-none text-sm"></textarea>
                            </div>

                            <div class="flex items-center gap-3 py-2">
                                <input type="checkbox" name="destacado" id="destacado" class="w-5 h-5 text-somno rounded focus:ring-somno">
                                <label for="destacado" class="text-sm font-bold text-slate-700">Destacar este evento</label>
                            </div>

                            <div class="flex gap-2 pt-4">
                                <button type="submit" id="submit-btn" class="flex-1 bg-somno text-white py-3 rounded-lg font-bold hover:bg-somno-light transition-colors cursor-pointer">
                                    Crear Evento
                                </button>
                                <button type="button" id="cancel-btn" onclick="resetForm()" class="hidden px-4 bg-slate-200 text-slate-600 rounded-lg font-bold hover:bg-slate-300">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-slate-600">
                                <thead class="bg-slate-50 text-somno uppercase font-bold text-xs">
                                    <tr>
                                        <th class="px-6 py-4">Fecha</th>
                                        <th class="px-6 py-4">Evento</th>
                                        <th class="px-6 py-4">Lugar/Precio</th>
                                        <th class="px-6 py-4 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {eventos?.map((evento) => (
                                        <tr class="hover:bg-slate-50/50 transition-colors group">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="font-bold text-slate-800">{evento.fecha}</div>
                                                <div class="text-xs text-somno font-bold">{evento.hora}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    <img src={evento.img} class="w-10 h-10 rounded-lg object-cover bg-slate-100" />
                                                    <div>
                                                        <div class="font-bold text-slate-800">{evento.titulo}</div>
                                                        <span class="inline-block text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-500">{evento.categoria}</span>
                                                        {evento.destacado && <span class="ml-1 inline-block text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full font-bold">★ Destacado</span>}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-xs">{evento.lugar}</div>
                                                <div class="text-xs font-bold text-slate-500">{evento.precio}</div>
                                            </td>
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex items-center justify-end gap-2">
                                                    
                                                    <button 
                                                        onclick={`editEvent(${JSON.stringify(evento)})`}
                                                        class="p-2 text-somno hover:bg-blue-50 rounded-lg transition-colors" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </button>

                                                    <button 
                                                        onclick={`openDeleteModal(${evento.id}, '${evento.titulo}')`}
                                                        class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar">
                                                        <i class="fas fa-trash"></i>
                                                    </button>

                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform transition-all scale-100 animate-fade-in-up">
            <div class="text-center">
                <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">¿Eliminar Evento?</h3>
                <p class="text-sm text-slate-500 mb-6">
                    Estás a punto de eliminar <span id="delete-event-title" class="font-bold text-slate-700"></span>. Esta acción no se puede deshacer.
                </p>
                
                <form method="POST" class="flex gap-3">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="id" id="delete-event-id">
                    
                    <button type="button" onclick="closeDeleteModal()" class="flex-1 px-4 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-500/30">
                        Sí, eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>

</Layout>

<script is:inline>
    // Referencias Formulario
    const form = document.getElementById('event-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const formAction = document.getElementById('form-action');
    const idInput = document.getElementById('event-id');

    // Referencias Modal Eliminar
    const deleteModal = document.getElementById('delete-modal');
    const deleteIdInput = document.getElementById('delete-event-id');
    const deleteTitleSpan = document.getElementById('delete-event-title');

    // --- FUNCIONES EDICIÓN ---
    window.editEvent = (evento) => {
        formTitle.innerText = "Editar Evento";
        submitBtn.innerText = "Guardar Cambios";
        submitBtn.classList.remove('bg-slate-900');
        submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        cancelBtn.classList.remove('hidden');
        
        formAction.value = "update";
        idInput.value = evento.id;

        document.getElementById('titulo').value = evento.titulo;
        document.getElementById('fecha').value = evento.fecha;
        document.getElementById('hora').value = evento.hora;
        document.getElementById('categoria').value = evento.categoria;
        document.getElementById('precio').value = evento.precio;
        document.getElementById('lugar').value = evento.lugar;
        document.getElementById('img').value = evento.img;
        document.getElementById('descripcion').value = evento.descripcion || '';
        document.getElementById('destacado').checked = evento.destacado;

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.resetForm = () => {
        form.reset();
        formTitle.innerText = "Nuevo Evento";
        submitBtn.innerText = "Crear Evento";
        submitBtn.classList.add('bg-slate-900');
        submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        cancelBtn.classList.add('hidden');
        formAction.value = "create";
        idInput.value = "";
    };

    // --- FUNCIONES MODAL ELIMINAR ---
    window.openDeleteModal = (id, titulo) => {
        deleteIdInput.value = id;
        deleteTitleSpan.innerText = `"${titulo}"`;
        deleteModal.classList.remove('hidden');
    };

    window.closeDeleteModal = () => {
        deleteModal.classList.add('hidden');
    };

    // Cerrar modal al hacer click fuera
    window.addEventListener('click', (e) => {
        if (e.target === deleteModal) {
            closeDeleteModal();
        }
    });
</script>

<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.2s ease-out forwards;
    }
</style>