---
import Layout from "../../layouts/Layout.astro"
import { createClient } from "@supabase/supabase-js"
import Icon from "../../components/Icon.astro"
import BackButton from "../../components/BackButton.astro"

const { id } = Astro.params;

if (!id) return Astro.redirect("/citas");

const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

let mensaje = "";
let error = false;

// Actualizar Datos (Si es POST)
if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        
        const fechaLocal = data.get("fecha_hora") as string;
        const fechaObj = new Date(`${fechaLocal}-06:00`);

        const actualizacion = {
            nombre: data.get("nombre"),
            // Agregamos '|| null' para permitir vacíos
            motivo: data.get("motivo"),
            telefono: data.get("telefono") || null,
            sintoma: data.get("sintoma") || null,
            referencia: data.get("referencia"),
            fecha_hora: fechaObj.toISOString(),
            observaciones: data.get("observaciones") || null,
        };

        const { error: updateError } = await supabase
            .from('citas')
            .update(actualizacion)
            .eq('id', id);

        if (updateError) throw updateError;
        
        return Astro.redirect("/citas"); // Redirigir al éxito

    } catch (e) {
        console.error(e);
        error = true;
        mensaje = "Error al actualizar la cita.";
    }
}

// Obtener Datos actuales para rellenar el formulario
const { data: cita, error: fetchError } = await supabase
    .from('citas')
    .select('*')
    .eq('id', id)
    .single();

if (fetchError || !cita) return Astro.redirect("/citas");

const fechaObjCita = new Date(cita.fecha_hora);

// Obtenemos la fecha (YYYY-MM-DD) en horario Mérida
const fechaParte = fechaObjCita.toLocaleDateString('en-CA', { 
    timeZone: 'America/Merida' 
});

// Obtenemos la hora (HH:MM) en horario Mérida (formato 24h)
const horaParte = fechaObjCita.toLocaleTimeString('en-GB', { 
    timeZone: 'America/Merida', 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: false 
});

// Unimos ambas partes con una "T"
const fechaValue = `${fechaParte}T${horaParte}`;
---

<Layout title="Editar Cita" showFooter={false}>
    <Icon />
	<div class="absolute top-8 left-5 xs:p-5 animate-fade-in-down" style="animation-delay: 0.1s;">
        <BackButton href="/citas" label="Volver a las citas" />
    </div>

    <main class="max-w-7xl mx-auto pt-10 pb-28 px-4">
        <div class="flex flex-col items-center justify-center mb-10">
            <h1 class="mt-10 md:mt-0 max-md:max-w-xs max-md:pt-10 max-lg:max-w-xl text-4xl md:text-6xl font-extrabold text-balance text-center bg-linear-to-r from-somno-light via-somno to-somno-dark bg-clip-text text-transparent">Editar cita</h1>
		</div>

        <form method="POST">
            <div class="flex flex-col items-center justify-center">
                
                <div class="flex flex-col space-y-4 w-full max-w-4xl px-2 md:px-0">
                    
                    <label class="text-lg font-medium text-somno-dark">Motivo de la cita:</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-somno-dark bg-somno-light/50 rounded-xl mb-4">
                        <label class="flex items-center gap-3 cursor-pointer text-slate-800 hover:text-somno-dark transition p-2 rounded">
                            <input type="radio" name="motivo" value="entrevista" checked={cita.motivo === 'entrevista'} required class="accent-somno-dark w-5 h-5">
                            <span class="font-medium">Entrevista Inicial</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer text-slate-800 hover:text-somno-dark transition p-2 rounded">
                            <input type="radio" name="motivo" value="seguimiento" checked={cita.motivo === 'seguimiento'} required class="accent-somno-dark w-5 h-5">
                            <span class="font-medium">Seguimiento</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer text-slate-800 hover:text-somno-dark transition p-2 rounded">
                            <input type="radio" name="motivo" value="tratamiento" checked={cita.motivo === 'tratamiento'} required class="accent-somno-dark w-5 h-5">
                            <span class="font-medium">Tratamiento</span>
                        </label>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-somno-dark">Nombre:</label>
                            <input type="text" name="nombre" value={cita.nombre} required class="mt-1 p-3 border border-somno-dark bg-somno-light/50 rounded-lg focus:ring-2 focus:ring-somno-dark text-somno-dark">
                        </div>

                        <div class="flex grow flex-col md:w-1/3">
                            <label class="text-lg font-medium text-somno-dark">Teléfono (Opcional):</label>
                            <input type="tel" name="telefono" value={cita.telefono} class="mt-1 p-3 border border-somno-dark bg-somno-light/50 rounded-lg focus:ring-2 focus:ring-somno-dark text-somno-dark">
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-somno-dark">Fecha y Hora:</label>
                            <input type="datetime-local" name="fecha_hora" value={fechaValue} required class="mt-1 p-3 border border-somno-dark bg-somno-light/50 rounded-lg focus:ring-2 focus:ring-somno-dark text-somno-dark" style="color-scheme: dark;">
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col md:w-1/3">
                            <label class="text-lg font-medium text-somno-dark">Referencia:</label>
                            <input type="text" name="referencia" value={cita.referencia} required class="mt-1 p-3 border border-somno-dark bg-somno-light/50 rounded-lg focus:ring-2 focus:ring-somno-dark text-somno-dark">
                        </div>
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-somno-dark">Síntoma (Opcional):</label>
                            <input type="text" name="sintoma" value={cita.sintoma} class="mt-1 p-3 border border-somno-dark bg-somno-light/50 rounded-lg focus:ring-2 focus:ring-somno-dark text-somno-dark">
                        </div>
                    </div>

                    <div class="flex flex-col mt-4">
                        <label class="text-lg font-medium text-somno-dark">Observaciones:</label>
                        <textarea name="observaciones" rows="3" class="mt-1 p-3 border border-somno-dark bg-somno-light/50 rounded-lg resize-y text-somno-dark">{cita.observaciones}</textarea>
                    </div>
                </div>

                <div class="pt-10 pb-10 w-full max-w-4xl flex justify-end gap-4">
                    <button type="submit" class="border border-somno-dark bg-slate-50 text-somno-dark font-semibold px-8 py-3 rounded-xl hover:bg-somno-dark hover:text-slate-50 hover:scale-105 transition transform duration-300 cursor-pointer">
                        Guardar Cambios
                    </button>
                </div>
                
            </div>
        </form>
    </main>
</Layout>