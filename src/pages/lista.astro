---
import Layout from "../layouts/Layout.astro"
import Icon from "../components/Icon.astro"
import { createClient } from '@supabase/supabase-js';
import BackButton from "../components/BackButton.astro"

const supabase = createClient(
	import.meta.env.PUBLIC_SUPABASE_URL,
	import.meta.env.SUPABASE_KEY
);

// Recupera lo que el usuario escribió en la URL
const busqueda = Astro.url.searchParams.get('q') || '';

// Construimos la consulta base
let consulta = supabase
    .from('pacientes')
    .select('id, nombre, edad, referencia, registrado_por, created_at')
    .order('created_at', { ascending: false })
    .limit(50);

// Si hay algo escrito, filtramos por nombre (insensible a mayúsculas/minúsculas)
if (busqueda) {
	consulta = consulta.ilike('nombre', `%${busqueda}%`);
}

// Ejecutamos la consulta final
const { data: pacientes, error } = await consulta;

if (error) console.error("Error cargando pacientes:", error);
---

<Layout title="Pacientes - Laboratorio del Sueño">
	<Icon />
	<div class="absolute top-8 left-5 xs:p-5 animate-fade-in-down" style="animation-delay: 0.1s;">
        <BackButton href="/dashboard" label="Volver al dashboard" />
    </div>
    <main class="max-w-7xl mx-auto pt-10 pb-28 px-4">
		<div class="flex flex-col items-center justify-center mb-10">
            <h1 class="font-black tracking-tighter text-7xl mt-15 lg:mt-0 md:text-8xl mb-6">
                <span class="bg-clip-text text-transparent bg-linear-to-r from-somno-light via-somno to-somno-dark pr-4">
                    SomnoLab
                </span>
            </h1>
		</div>

		<h2 class="text-2xl font-medium text-center text-somno mb-2">Lista de pacientes</h2>
        
        <div class="flex flex-col-reverse md:flex-row justify-between items-center gap-4 mb-8 mx-1">
    
			<form method="GET" class="w-full md:max-w-md relative group">
				<div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
					<svg class="w-4 h-4 text-somno-light group-focus-within:text-somno-dark transition-colors" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
						<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
					</svg>
				</div>

				<input 
					type="text" 
					name="q" 
					value={busqueda}
					class="block w-full p-3 ps-10 pr-36 text-sm text-somno-dark border border-somno rounded-lg bg-somno/20 focus:ring-2 focus:ring-somno-dark focus:border-transparent placeholder-somno-light transition-all shadow-lg" 
					placeholder="Buscar paciente..." 
					autocomplete="off"
				/>

				<div class="absolute inset-y-0 right-2 flex items-center gap-1">
					
					{busqueda && (
						<a href="/lista" class="text-somno-dark hover:text-somno-light hover:bg-somno-dark/10 p-1.5 rounded-md transition-colors flex items-center" title="Limpiar búsqueda">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
								<path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
							</svg>
						</a>
					)}

					<button type="submit" class="bg-somno hover:bg-somno-dark text-white font-medium rounded-md text-xs px-3 py-1.5 transition-colors cursor-pointer ml-1">
						Buscar
					</button>
				</div>
			</form>

			<a href="registro" class="w-full md:w-auto group relative overflow-hidden rounded-lg border border-somno bg-transparent px-6 py-2.5 text-somno shadow-sm transition-all hover:text-slate-50 hover:shadow-[0_0_20px_rgba(59,130,246,0.4)] hover:border-somno flex items-center justify-center md:justify-start">
				<span class="absolute inset-0 w-0 bg-somno transition-all duration-250 ease-out group-hover:w-full"></span>
				<span class="relative flex items-center gap-2 text-sm font-semibold tracking-wide uppercase">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
						<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
					</svg>
					Nuevo Registro
				</span>
			</a>

		</div>

		<div class="w-full overflow-hidden rounded-xl border border-somno-dark bg-somno-light/20 backdrop-blur shadow-lg overflow-x-auto">
			
            <table class="w-full text-left border-collapse min-w-[900px]">
				<thead class="bg-linear-to-r from-somno/30 via-transparent to-somno/30">
					<tr>
						<th class="px-8 py-4 text-somno-dark font-semibold text-sm uppercase tracking-wider">Nombre</th>
						<th class="px-6 py-4 text-somno-dark font-semibold text-sm uppercase tracking-wider">Edad</th>
						<th class="px-6 py-4 text-somno-dark font-semibold text-sm uppercase tracking-wider">Referencia</th>
						<th class="px-6 py-4 text-somno-dark font-semibold text-sm uppercase tracking-wider">Registró</th>
						<th class="px-6 py-4 text-somno-dark font-semibold text-sm uppercase tracking-wider text-right">Fecha</th>
					</tr>
				</thead>
				<tbody>
					{pacientes?.map((paciente) => (
						<tr 
							class="group cursor-pointer hover:bg-somno-dark/10 transition-colors relative"
							onclick={`window.location.href = '/paciente/${paciente.id}'`}
						>
							<td class="px-8 py-5 align-middle">
								<div class="flex items-center gap-3">
									<div class="w-2 h-2 rounded-full bg-somno-dark group-hover:bg-somno-primary group-hover:shadow-[0_0_8px_rgba(59,130,246,0.8)] transition-all"></div>
									<span class="text-somno-dark font-medium text-lg capitalize group-hover:text-somno-light transition-colors">
										{paciente.nombre}
									</span>
								</div>
                                <div class="absolute bottom-0 left-0 right-0 h-px bg-linear-to-r from-transparent via-somno-dark/50 to-transparent group-hover:via-somno-primary/50 transition-all"></div>
							</td>
							<td class="px-6 py-5 text-somno-dark/70 align-middle">{paciente.edad} años</td>
							<td class="px-6 py-5 text-somno-dark/70 align-middle">{paciente.referencia}</td>
							<td class="px-6 py-5 text-somno-dark/70 align-middle">
								{paciente.registrado_por || "—"}
							</td>
							<td class="px-6 py-5 text-somno-dark/70 font-mono text-sm align-middle text-right">
								{new Date(paciente.created_at).toLocaleDateString('es-MX', {
                                    year: '2-digit', month: 'short', day: 'numeric'
                                })}
							</td>
						</tr>
					))}
				</tbody>
			</table>
		</div>
		
	</main>
</Layout>