---
import Layout from "../../layouts/Layout.astro"
import SintomaGroup from "../../components/SintomaGroup.astro"
import PuntajeExtraGroup from "../../components/PuntajeExtraGroup.astro"
import { createClient } from "@supabase/supabase-js"

const { id } = Astro.params;
if (!id) return Astro.redirect("/lista");

const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

// --- LÓGICA DE ACTUALIZACIÓN ---
let mensaje = "";
let error = false;

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        
        const getInt = (key: string) => {
            const val = data.get(key);
            return val && val.toString().trim() !== '' ? parseInt(val as string) : null;
        };

        // 1. Calcular Edad (igual que en registro)
        let edadCalculada = 0;
        const fechaNacString = data.get("fecha_nacimiento") as string;
        if (fechaNacString) {
            const hoy = new Date();
            const cumple = new Date(fechaNacString);
            let edad = hoy.getFullYear() - cumple.getFullYear();
            const m = hoy.getMonth() - cumple.getMonth();
            if (m < 0 || (m === 0 && hoy.getDate() < cumple.getDate())) { edad--; }
            edadCalculada = edad;
        }

        const pacienteUpdate = {
            nombre: data.get("nombre"),
            edad: edadCalculada,
            fecha_nacimiento: fechaNacString || null,
            genero: data.get("genero"),
            ocupacion: data.get("ocupacion"),
            escolaridad: data.get("escolaridad"),
            referencia: data.get("referencia"),
            motivo: data.get("motivo"),
            
            lateralidad: data.get("lateralidad"),
            peso: data.get("peso") ? parseFloat(data.get("peso") as string) : null,
            altura: data.get("altura") ? parseFloat(data.get("altura") as string) : null,

            donde_duerme: data.get("donde_duerme"),
            hora_dormir: data.get("hora_dormir"),
            hora_levantarse: data.get("hora_levantarse"),
            tiempo_dormir: data.get("tiempo_dormir"),
            despierta_noche: data.get("despierta_noche"),
            que_despierta: data.get("que_despierta"),
            somnolencia: data.get("somnolencia"),
            siesta: data.get("siesta"),
            dias_siesta: getInt("dias_siesta"),
            tiempo_siesta: data.get("tiempo_siesta"),
            ejercicio: data.get("ejercicio"),
            horas_ejercicio: data.get("horas_ejercicio"),

            fuma: data.get("fuma"),
            cigarros_semana: getInt("cigarros_semana"),
            alcohol: data.get("alcohol"),
            cervezas_semana: getInt("cervezas_semana"),
            cafe: data.get("cafe"),
            tazas_cafe_semana: getInt("tazas_cafe_semana"),
            te: data.get("te"),
            tazas_te_semana: getInt("tazas_te_semana"),

            antecedentes: data.get("antecedentes"),
            
            // Campos legacy del síntoma principal
            sintoma: data.getAll('sintoma')[0]?.toString(),
            temporalidad: data.getAll('temporalidad')[0]?.toString(),
            frecuencia: data.getAll('frecuencia')[0]?.toString(),
            gravedad: data.getAll('gravedad')[0]?.toString(),

            alteracion_sueno: data.get("alteracion_sueno"),

            epworth: getInt("epworth"),
            dbi: getInt("dbi"),
            hamilton_d: getInt("hamilton_d"),
            hamilton_a: getInt("hamilton_a"),
            isi: getInt("isi"),
            spqi: getInt("spqi"),
            stop_bang: getInt("stop_bang"),
            berlin: getInt("berlin"),
            cuestionario_insomnio: getInt("cuestionario_insomnio"),
        };

        // 2. Actualizar Tabla Principal
        const { error: updateError } = await supabase
            .from('pacientes')
            .update(pacienteUpdate)
            .eq('id', id);

        if (updateError) throw updateError;

        // 3. Actualizar Síntomas (Borrar todo y reinsertar)
        await supabase.from('pacientes_sintomas').delete().eq('paciente_id', id);
        
        const sintomas = data.getAll('sintoma');
        const temporalidades = data.getAll('temporalidad');
        const frecuencias = data.getAll('frecuencia');
        const gravedades = data.getAll('gravedad');

        const sintomasInsert = sintomas.map((s, i) => ({
            paciente_id: id,
            sintoma: s.toString(),
            temporalidad: temporalidades[i]?.toString(),
            frecuencia: frecuencias[i]?.toString(),
            gravedad: gravedades[i]?.toString()
        })).filter(s => s.sintoma.trim() !== '');

        if (sintomasInsert.length > 0) {
            await supabase.from('pacientes_sintomas').insert(sintomasInsert);
        }

        // 4. Actualizar Puntajes Extra (Borrar y reinsertar)
        await supabase.from('pacientes_puntajes_extra').delete().eq('paciente_id', id);

        const extraNombres = data.getAll('extra_prueba_nombre');
        const extraValores = data.getAll('extra_prueba_valor');
        
        const extrasInsert = extraNombres.map((n, i) => ({
            paciente_id: id,
            nombre_prueba: n.toString(),
            puntaje: extraValores[i] ? parseInt(extraValores[i].toString()) : null
        })).filter(e => e.nombre_prueba.trim() !== '');

        if (extrasInsert.length > 0) {
            await supabase.from('pacientes_puntajes_extra').insert(extrasInsert);
        }

        return Astro.redirect(`/paciente/${id}`);

    } catch (e) {
        console.error(e);
        error = true;
        mensaje = e instanceof Error ? e.message : "Error al actualizar";
    }
}

// --- CARGA DE DATOS ---
const { data: p, error: loadError } = await supabase
    .from('pacientes')
    .select('*, pacientes_sintomas(*), pacientes_puntajes_extra(*)')
    .eq('id', id)
    .single();

if (loadError || !p) return Astro.redirect("/lista");

// Asegurar al menos un elemento en arrays para renderizar
const listaSintomas = p.pacientes_sintomas && p.pacientes_sintomas.length > 0 ? p.pacientes_sintomas : [{}];
const listaExtras = p.pacientes_puntajes_extra || [];
---

<Layout title={`Editar: ${p.nombre}`}>

    {error && (
        <div class="fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg text-white shadow-lg bg-red-600 z-50">{mensaje}</div>
    )}

    <main class="max-w-7xl mx-auto pt-6 md:pt-10 pb-28 px-4">
        <div class="flex flex-col items-center justify-center mb-8">
            <h1 class="font-black tracking-tighter text-5xl md:text-6xl mb-6">
                <span class="bg-clip-text text-transparent bg-linear-to-r from-somno-light via-somno to-somno-dark pr-4">
                    Edición de Paciente
                </span>
            </h1>
            <p class="text-xl text-somno-dark font-bold"> ● Editando a: <span class="text-somno-light">{p.nombre}</span> ●</p>
		</div>

        <form method="POST">
            <div class="flex flex-col items-center justify-center space-y-12">
                
                <section class="w-full max-w-4xl px-2 md:px-0">
                    <h2 class="section-title">SocioDemográficos</h2>
                    <div class="flex flex-col space-y-4">
                        <div class="flex flex-col">
                            <label class="text-lg font-medium text-somno-dark">Nombre completo:</label>
                            <input type="text" name="nombre" value={p.nombre} required class="input">
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                            <div class="flex grow flex-col md:w-1/2"> 
                                <label class="text-lg font-medium text-somno-dark">Fecha de Nacimiento:</label>
                                <input type="date" name="fecha_nacimiento" value={p.fecha_nacimiento} required class="input" style="color-scheme: dark;">
                            </div>
                            <div class="flex grow flex-col md:w-1/2"> 
                                <label class="text-lg font-medium text-somno-dark">Género:</label>
                                <select name="genero" class="input appearance-none">
                                    <option class="bg-gray-900" value="masculino" selected={p.genero === 'masculino'}>Masculino</option>
                                    <option class="bg-gray-900" value="femenino" selected={p.genero === 'femenino'}>Femenino</option>
                                    <option class="bg-gray-900" value="otro" selected={p.genero === 'otro'}>Otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                            <div class="flex grow flex-col">
                                <label class="text-lg font-medium text-somno-dark">Ocupación:</label>
                                <input type="text" name="ocupacion" value={p.ocupacion} class="input">
                            </div>
                            <div class="flex grow flex-col">
                                <label class="text-lg font-medium text-somno-dark">Escolaridad:</label>
                                <select name="escolaridad" class="input appearance-none">
                                    {["Primaria", "Secundaria", "Preparatoria", "Licenciatura", "Maestría", "Doctorado"].map(opt => (
                                        <option class="bg-gray-900" value={opt} selected={p.escolaridad === opt}>{opt}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                            <div class="flex grow flex-col md:w-1/3">
                                <label class="text-lg font-medium text-somno-dark">¿Quién lo refiere?</label>
                                <input type="text" name="referencia" value={p.referencia} required class="input">
                            </div>
                            <div class="flex grow flex-col">
                                <label class="text-lg font-medium text-somno-dark">Motivo de la consulta</label>
                                <input type="text" name="motivo" value={p.motivo} required class="input">
                            </div>
                        </div>
                    </div>
                </section>

                <section class="w-full max-w-4xl px-2 md:px-0">
                    <h2 class="section-title">Antropométricos</h2>
                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col md:w-1/2">
                            <label class="text-lg font-medium text-somno-dark">Lateralidad:</label>
                            <select name="lateralidad" class="input appearance-none">
                                <option class="bg-gray-900" value="diestro" selected={p.lateralidad === 'diestro'}>Diestro</option>
                                <option class="bg-gray-900" value="zurdo" selected={p.lateralidad === 'zurdo'}>Zurdo</option>
                                <option class="bg-gray-900" value="ambidiestro" selected={p.lateralidad === 'ambidiestro'}>Ambidiestro</option>
                            </select>
                        </div>
                        <div class="flex grow flex-col md:w-1/2">
                            <label class="text-lg font-medium text-somno-dark">Peso (kg):</label>
                            <input type="number" name="peso" step="0.1" value={p.peso} class="input">
                        </div>
                        <div class="flex grow flex-col md:w-1/2">
                            <label class="text-lg font-medium text-somno-dark">Altura (m):</label>
                            <input type="number" name="altura" step="0.01" value={p.altura} class="input">
                        </div>
                    </div>
                </section>

                <section class="w-full max-w-4xl px-2 md:px-0">
                    <h2 class="section-title">Hábitos y patrones</h2>
                    <div class="flex flex-col space-y-6">
                        <div class="flex flex-col">
                            <label class="text-lg font-medium text-somno-dark mb-2">¿Dónde duerme?</label>
                            <div class="flex flex-wrap gap-6 p-3 border border-somno-dark bg-somno-light/50 rounded-lg">
                                {['cama', 'hamaca', 'ambas'].map(val => (
                                    <label class="flex items-center gap-2 cursor-pointer hover:text-somno-dark transition">
                                        <input type="radio" name="donde_duerme" value={val} checked={p.donde_duerme === val} class="accent-somno-dark w-4 h-4 uppercase"/> <span class="capitalize">{val}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                            <div class="flex grow flex-col">
                                <label class="text-lg font-medium text-somno-dark">Hora de dormir:</label>
                                <input type="time" name="hora_dormir" value={p.hora_dormir} class="input" style="color-scheme: dark;">
                            </div>
                            <div class="flex grow flex-col">
                                <label class="text-lg font-medium text-somno-dark">Hora de levantarse:</label>
                                <input type="time" name="hora_levantarse" value={p.hora_levantarse} class="input" style="color-scheme: dark;">
                            </div>
                            <div class="flex grow flex-col">
                                <label class="text-lg font-medium text-somno-dark">Tiempo en dormir:</label>
                                <input type="text" name="tiempo_dormir" value={p.tiempo_dormir} class="input">
                            </div>
                        </div>

                        <div class="cond-block">
                            <label class="text-lg font-medium text-somno-dark">¿Se despierta por las noches?</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="despierta_noche" value="si" checked={p.despierta_noche === 'si'} class="accent-somno-dark trigger-condicional" data-target="div_que_despierta"> Sí</label>
                                <label class="flex items-center gap-2"><input type="radio" name="despierta_noche" value="no" checked={p.despierta_noche !== 'si'} class="accent-somno-dark trigger-condicional" data-target="div_que_despierta"> No</label>
                            </div>
                            <div id="div_que_despierta" class={p.despierta_noche === 'si' ? "mt-3" : "hidden mt-3"}>
                                <label class="sub-label">¿Qué lo despierta?</label>
                                <input type="text" name="que_despierta" value={p.que_despierta} class="input-sub">
                            </div>
                        </div>

                        <div class="cond-block">
                            <label class="text-lg font-medium text-somno-dark">¿Padece somnolencia?</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="somnolencia" value="si" checked={p.somnolencia === 'si'} class="accent-somno-dark"> Sí</label>
                                <label class="flex items-center gap-2"><input type="radio" name="somnolencia" value="no" checked={p.somnolencia !== 'si'} class="accent-somno-dark"> No</label>
                            </div>
                        </div>

                        <div class="cond-block">
                            <label class="text-lg font-medium text-somno-dark">¿Toma siestas?</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="siesta" value="si" checked={p.siesta === 'si'} class="accent-somno-dark trigger-condicional" data-target="div_datos_siesta"> Sí</label>
                                <label class="flex items-center gap-2"><input type="radio" name="siesta" value="no" checked={p.siesta !== 'si'} class="accent-somno-dark trigger-condicional" data-target="div_datos_siesta"> No</label>
                            </div>
                            <div id="div_datos_siesta" class={p.siesta === 'si' ? "grid grid-cols-2 gap-4 mt-3" : "hidden grid grid-cols-2 gap-4 mt-3"}>
                                <div><label class="sub-label">Días/semana</label><input type="number" name="dias_siesta" value={p.dias_siesta} class="input-sub"></div>
                                <div><label class="sub-label">Duración</label><input type="text" name="tiempo_siesta" value={p.tiempo_siesta} class="input-sub"></div>
                            </div>
                        </div>

                        <div class="cond-block">
                            <label class="text-lg font-medium text-somno-dark">¿Realiza ejercicio?</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="ejercicio" value="si" checked={p.ejercicio === 'si'} class="accent-somno-dark trigger-condicional" data-target="div_horas_ejercicio"> Sí</label>
                                <label class="flex items-center gap-2"><input type="radio" name="ejercicio" value="no" checked={p.ejercicio !== 'si'} class="accent-somno-dark trigger-condicional" data-target="div_horas_ejercicio"> No</label>
                            </div>
                            <div id="div_horas_ejercicio" class={p.ejercicio === 'si' ? "mt-3" : "hidden mt-3"}>
                                <text-lg font-medium text-somno-dark class="sub-label">Horas/semana</text-lg><input type="text" name="horas_ejercicio" value={p.horas_ejercicio} class="input-sub md:w-1/2">
                            </div>
                        </div>
                    </div>
                </section>

                <section class="w-full max-w-4xl px-2 md:px-0">
                    <h2 class="section-title">Consumo de sustancias</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Fuma */}
                        <div class="cond-block">
                            <label class="text-lg font-medium text-somno-dark">¿Fuma?</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="fuma" value="si" checked={p.fuma === 'si'} class="accent-somno-dark trigger-condicional" data-target="div_fuma"> Sí</label>
                                <label class="flex items-center gap-2"><input type="radio" name="fuma" value="no" checked={p.fuma !== 'si'} class="accent-somno-dark trigger-condicional" data-target="div_fuma"> No</label>
                            </div>
                            <div id="div_fuma" class={p.fuma === 'si' ? "mt-3" : "hidden mt-3"}><text-lg font-medium text-somno-dark class="sub-label">Cigarros/semana</text-lg><input type="number" name="cigarros_semana" value={p.cigarros_semana} class="input-sub"></div>
                        </div>
                        {/* Alcohol */}
                        <div class="cond-block">
                            <label class="text-lg font-medium text-somno-dark">¿Alcohol?</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="alcohol" value="si" checked={p.alcohol === 'si'} class="accent-somno-dark trigger-condicional" data-target="div_alcohol"> Sí</label>
                                <label class="flex items-center gap-2"><input type="radio" name="alcohol" value="no" checked={p.alcohol !== 'si'} class="accent-somno-dark trigger-condicional" data-target="div_alcohol"> No</label>
                            </div>
                            <div id="div_alcohol" class={p.alcohol === 'si' ? "mt-3" : "hidden mt-3"}><label class="sub-label">Cervezas/semana</label><input type="number" name="cervezas_semana" value={p.cervezas_semana} class="input-sub"></div>
                        </div>
                        {/* Cafe */}
                        <div class="cond-block">
                            <label class="text-lg font-medium text-somno-dark">¿Café?</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="cafe" value="si" checked={p.cafe === 'si'} class="accent-somno-dark trigger-condicional" data-target="div_cafe"> Sí</label>
                                <label class="flex items-center gap-2"><input type="radio" name="cafe" value="no" checked={p.cafe !== 'si'} class="accent-somno-dark trigger-condicional" data-target="div_cafe"> No</label>
                            </div>
                            <div id="div_cafe" class={p.cafe === 'si' ? "mt-3" : "hidden mt-3"}><label class="sub-label">Tazas/semana</label><input type="number" name="tazas_cafe_semana" value={p.tazas_cafe_semana} class="input-sub"></div>
                        </div>
                        {/* Te */}
                        <div class="cond-block">
                            <label class="text-lg font-medium text-somno-dark">¿Té?</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2"><input type="radio" name="te" value="si" checked={p.te === 'si'} class="accent-somno-dark trigger-condicional" data-target="div_te"> Sí</label>
                                <label class="flex items-center gap-2"><input type="radio" name="te" value="no" checked={p.te !== 'si'} class="accent-somno-dark trigger-condicional" data-target="div_te"> No</label>
                            </div>
                            <div id="div_te" class={p.te === 'si' ? "mt-3" : "hidden mt-3"}><label class="sub-label">Tazas/semana</label><input type="number" name="tazas_te_semana" value={p.tazas_te_semana} class="input-sub"></div>
                        </div>
                    </div>
                </section>

                <section class="w-full max-w-4xl px-2 md:px-0">
                    <h2 class="section-title">Diagnósticos previos</h2>
                    <div class="flex flex-col">
                        <label for="antecedentes" class="text-lg font-medium text-somno-dark">Antecedentes familiares</label>
                        <textarea name="antecedentes" rows="4" class="input resize-y">{p.antecedentes}</textarea>
                    </div>
                </section>

                <section class="w-full max-w-4xl px-2 md:px-0">
                    <h2 class="section-title">Análisis de síntomas</h2>
                    <div id="lista-sintomas" class="space-y-8">
                        {listaSintomas.map((s:any, idx:any) => (
                            <SintomaGroup numero={idx + 1} data={s} />
                        ))}
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="button" id="btn-add-sintoma" class="flex items-center gap-2 text-sm font-medium text-somno-dark hover:text-white transition-colors border border-somno-dark/30 hover:bg-somno-dark px-4 py-2 rounded-lg cursor-pointer">
                            <span class="text-xl leading-none">+</span> Agregar otro síntoma
                        </button>
                    </div>
                </section>

                <section class="w-full max-w-4xl px-2 md:px-0">
                    <h2 class="section-title">Alteraciones del sueño</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-somno-dark rounded-xl bg-somno-light/50">
                        {['insomnio', 'respiracion', 'ritmo_circadiano', 'movimiento', 'parasomnia', 'hipersomnia', 'medicas_psiquiatricas', 'sustancias'].map(val => (
                            <label class="flex items-center gap-3 cursor-pointer hover:text-somno-dark p-2 rounded-lg hover:bg-white/5">
                                <input type="radio" name="alteracion_sueno" value={val} checked={p.alteracion_sueno === val} class="accent-somno-dark w-4 h-4"/>
                                <span class="capitalize">{val.replace('_', ' ')}</span>
                            </label>
                        ))}
                    </div>
                </section>

                <section class="w-full max-w-4xl px-2 md:px-0">
                    <h2 class="section-title">Puntajes</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        {['epworth', 'dbi', 'hamilton_d', 'hamilton_a', 'isi', 'spqi', 'stop_bang', 'berlin'].map(score => (
                            <div class="flex flex-col">
                                <label class="text-lg font-medium text-somno-dark capitalize">{score.replace('_', '-')}</label>
                                <input type="number" name={score} value={p[score]} class="input text-center font-mono"/>
                            </div>
                        ))}
                        <div class="flex flex-col col-span-2">
                            <label class="text-lg font-medium text-somno-dark">Cuest. Insomnio</label>
                            <input type="number" name="cuestionario_insomnio" value={p.cuestionario_insomnio} class="input text-center font-mono"/>
                        </div>
                    </div>

                    <div class="border-t border-gray-800 pt-6">
                        <h3 class="text-lg font-medium text-somno-dark mb-4">Otros Puntajes</h3>
                        <div id="lista-puntajes-extra" class="space-y-4">
                            <PuntajeExtraGroup className="puntaje-extra-template hidden" />
                            {listaExtras.map((extra: any) => (
                                <PuntajeExtraGroup className="puntaje-extra-item" data={extra} />
                            ))}
                        </div>
                        <div class="mt-4">
                            <button type="button" id="btn-add-puntaje" class="flex items-center gap-2 text-sm font-medium text-somno-dark hover:text-white transition-colors border border-somno-dark hover:bg-somno-dark px-4 py-2 rounded-lg cursor-pointer">
                                <span class="text-xl leading-none">+</span> Agregar otro puntaje
                            </button>
                        </div>
                    </div>
                </section>

                <div class="pt-10 pb-10">
                    <button type="submit" class="w-full md:w-auto bg-somno text-white text-lg font-semibold px-8 py-3 rounded-xl hover:bg-somno-light hover:scale-105 hover:shadow-[0_0_20px_rgba(37,99,235,0.5)] transition duration-300 cursor-pointer active:scale-95">
                        Guardar Cambios
                    </button>
                </div>
            </div>
        </form>
    </main>
</Layout>

<style>
    @reference "../../styles/global.css";
    .section-title { @apply text-2xl md:text-3xl pb-2 mb-6 border-b border-somno-dark text-center text-somno-dark w-fit mx-auto px-10; }
    .sub-label { @apply text-sm font-medium text-somno-dark block mb-1; }
    .input { @apply mt-1 p-3 border border-somno-dark bg-somno-light/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-somno-dark text-somno-dark transition-all w-full; }
    .input-sub { @apply w-full p-2 border border-somno-dark/30 bg-somno-dark/30 rounded-lg focus:outline-none focus:ring-1 focus:ring-somno-dark text-somno-dark; }
    .cond-block { @apply flex flex-col space-y-2 p-4 border border-somno-dark rounded-xl bg-somno-light/50; }
</style>

<script>
    function initEdit() {
        // 1. Condicionales
        const triggers = document.querySelectorAll('.trigger-condicional');
        triggers.forEach(trigger => {
            trigger.addEventListener('change', (e) => {
                const target = e.target as HTMLInputElement; 
                const targetId = target.dataset.target;
                if (!targetId) return;
                const targetDiv = document.getElementById(targetId);
                if (targetDiv) {
                    if (target.value === 'si') {
                        targetDiv.classList.remove('hidden');
                        targetDiv.querySelectorAll('input').forEach(i => i.removeAttribute('disabled'));
                    } else {
                        targetDiv.classList.add('hidden');
                        targetDiv.querySelectorAll('input').forEach((i: HTMLInputElement) => {
                            i.value = '';
                            i.setAttribute('disabled', 'true');
                        });
                    }
                }
            });
        });

        // 2. Síntomas Dinámicos (Clonar solo el primero como template si se necesita más)
        const btnAddSintoma = document.getElementById('btn-add-sintoma');
        const listaSintomas = document.getElementById('lista-sintomas');
        
        // Inicializar botones delete existentes
        const initDeleteSintoma = (parent: Element) => {
            const btn = parent.querySelector('.btn-delete-sintoma');
            if (btn) {
                btn.classList.remove('hidden');
                btn.addEventListener('click', () => {
                    if (document.querySelectorAll('.sintoma-group').length > 1) {
                        parent.remove();
                        // Renumerar
                        document.querySelectorAll('.sintoma-group').forEach((el, i) => {
                            const t = el.querySelector('.sintoma-titulo');
                            if(t) t.textContent = `Síntoma ${i+1}`;
                        });
                    } else {
                        alert("Debe haber al menos un síntoma.");
                    }
                });
            }
        };
        // Aplicar a los cargados del servidor (menos el primero si es único)
        const serverSintomas = document.querySelectorAll('.sintoma-group');
        if (serverSintomas.length > 1) {
            serverSintomas.forEach(initDeleteSintoma);
        } else if (serverSintomas.length === 1) {
            // Si solo hay uno, nos aseguramos que el botón esté oculto o listo para futuros clones
            // (La lógica de clonación usará este como base)
        }

        if (btnAddSintoma && listaSintomas) {
            btnAddSintoma.addEventListener('click', () => {
                const original = listaSintomas.querySelector('.sintoma-group');
                if (!original) return;
                const clone = original.cloneNode(true) as HTMLElement;
                clone.querySelectorAll('input').forEach((i: HTMLInputElement) => i.value = '');
                
                // Activar delete en el clon
                initDeleteSintoma(clone);
                // Si el original no tenía delete visible, el clon sí debe tenerlo
                clone.querySelector('.btn-delete-sintoma')?.classList.remove('hidden');

                // Asegurarse que el original (si era único) ahora tenga botón visible también
                if (listaSintomas.querySelectorAll('.sintoma-group').length === 1) {
                    initDeleteSintoma(original);
                }

                const total = listaSintomas.querySelectorAll('.sintoma-group').length + 1;
                const tit = clone.querySelector('.sintoma-titulo');
                if (tit) tit.textContent = `Síntoma ${total}`;
                
                listaSintomas.appendChild(clone);
            });
        }

        // 3. Puntajes Extra
        const btnAddPuntaje = document.getElementById('btn-add-puntaje');
        const listaExtras = document.getElementById('lista-puntajes-extra');
        const templateExtra = document.querySelector('.puntaje-extra-template');

        const initDeleteExtra = (btn: Element) => {
            btn.classList.remove('hidden');
            btn.addEventListener('click', (e) => (e.target as HTMLElement).closest('.puntaje-extra-group')?.remove());
        };

        // Init existentes
        document.querySelectorAll('.puntaje-extra-item .btn-delete-puntaje').forEach(initDeleteExtra);

        if (btnAddPuntaje && listaExtras && templateExtra) {
            btnAddPuntaje.addEventListener('click', () => {
                const clone = templateExtra.cloneNode(true) as HTMLElement;
                clone.classList.remove('hidden', 'puntaje-extra-template');
                clone.classList.add('puntaje-extra-item');
                clone.querySelectorAll('input').forEach((i: HTMLInputElement) => i.value = '');
                
                const btn = clone.querySelector('.btn-delete-puntaje');
                if (btn) initDeleteExtra(btn);
                
                listaExtras.appendChild(clone);
            });
        }
    }
    document.addEventListener('DOMContentLoaded', initEdit);
</script>